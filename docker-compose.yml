
services:
  user-db:
    image: postgres:16
    container_name: user-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: AkAli12201377
      POSTGRES_DB: user_db
    volumes:
      - user_db_data:/var/lib/postgresql/data
    restart: unless-stopped

  product-db:
    image: postgres:16
    container_name: product-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: AkAli12201377
      POSTGRES_DB: product_db
    volumes:
      - product_db_data:/var/lib/postgresql/data
    restart: unless-stopped

  order-db:
    image: postgres:16
    container_name: order-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: AkAli12201377
      POSTGRES_DB: order_db
    volumes:
      - order_db_data:/var/lib/postgresql/data
    restart: unless-stopped

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: adminpassword
    ports:
      - "8080:80"
    depends_on:
      - user-db
      - product-db
      - order-db
    restart: unless-stopped

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"     # AMQP
      - "15672:15672"   # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    restart: unless-stopped

  mailhog:
    image: mailhog/mailhog
    container_name: mailhog
    ports:
      - "1025:1025"     # SMTP
      - "8025:8025"     # Web UI
    restart: unless-stopped

  payment-service:
    build: ./services/payment-service
    container_name: payment-service
    environment:
      - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/
      - USER_SERVICE_URL=http://user-service:8000
      - ORDER_SERVICE_URL=http://order-service:8000
      # Stripe (test keys)
      # IMPORTANT: set these in your environment or replace the values below.
      - STRIPE_SECRET_KEY=sk_test_51SjmsBJSz5F5X8ASPhrCQ46NbDWZgz0a9wZTBcwKL9UHXlsZGgEM3LVeg5v6wVf3KoeAdG6sR1tQowl1EB4ecYFj00P5TLP1L5
      - STRIPE_PUBLISHABLE_KEY=pk_test_51SjmsBJSz5F5X8AS4aPIqYpob1It3VQ2TT83ePEfvu08NyfXVtlFZXnL3un2V8sJnwj5Asop2byg3r1J9HfvK2py00kfl0aZW7
      - STRIPE_WEBHOOK_SECRET=whsec_8224012013e374e48812981c2d5580a9a6b88276a487ebde960a53e2bdf90438
      - STRIPE_CURRENCY=${STRIPE_CURRENCY:-usd}
      # Public base URL for opening the hosted payment page from your browser
      - PAYMENT_PUBLIC_URL=${PAYMENT_PUBLIC_URL:-http://localhost:8003}
    ports:
      - "8003:8000"
    depends_on:
      - rabbitmq
    restart: unless-stopped

  user-service:
    build: ./services/user-service
    container_name: user-service
    environment:
      - DATABASE_URL=postgresql://postgres:AkAli12201377@user-db:5432/user_db
      - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/
    ports:
      - "8000:8000"
    depends_on:
      - user-db
      - rabbitmq
    restart: unless-stopped

  product-service:
    build: ./services/product-service
    container_name: product-service
    environment:
      - DATABASE_URL=postgresql://postgres:AkAli12201377@product-db:5432/product_db
      - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/
    ports:
      - "8001:8000"
    depends_on:
      - product-db
      - rabbitmq
    restart: unless-stopped

  order-service:
    build: ./services/order-service
    container_name: order-service
    environment:
      - DATABASE_URL=postgresql://postgres:AkAli12201377@order-db:5432/order_db
      - USER_SERVICE_URL=http://user-service:8000
      - PRODUCT_SERVICE_URL=http://product-service:8000
      - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/
      - SECRET_KEY=8f3b9e7a2c4d1f5e6a8b0c9d3e7f2a1b4c6d8e9f0a5b7c2d1e3f4a6b8c9d0e1f2
    ports:
      - "8002:8000"
    depends_on:
      - order-db
      - user-service
      - product-service
      - rabbitmq
      - payment-service
    restart: unless-stopped

  notification-service:
    build: ./services/notification-service
    container_name: notification-service
    environment:
      - RABBITMQ_URL=amqp://admin:admin123@rabbitmq:5672/
      - EVENTS_EXCHANGE=ecom.events
      - SMTP_HOST=mailhog
      - SMTP_PORT=1025
      - SMTP_FROM=no-reply@example.com
      # If user email is missing, send to this address
      - NOTIFY_FALLBACK_TO=test@example.com
      # Optional: force all emails to one address for testing
      # - NOTIFY_FORCE_TO=you@example.com
    ports:
      - "8004:8000"
    depends_on:
      - rabbitmq
      - mailhog
    restart: unless-stopped

volumes:
  user_db_data:
  product_db_data:
  order_db_data:
